<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>{% block title %}Golshi's Encryptor{% endblock %}</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      /* Base styles */
      body,
      html {
        margin: 0;
        padding: 0;
        width: 100%;
        font-family: Muller, sans-serif;
        background: #dbdae7;
        overflow-x: hidden;
      }

      /* --- Header / Nav --- */
      .app-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 40px;
        background: #e72e40;
        color: white;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        position: sticky;
        top: 0;
        z-index: 1000;
      }
      .app-header .logo {
        font-family: "LEMON MILK", sans-serif;
        font-size: 24px;
        font-weight: 700;
      }
      .app-header nav {
        display: flex;
        align-items: center;
        gap: 25px;
      }
      .app-header nav a {
        color: white;
        text-decoration: none;
        font-family: "LEMON MILK", sans-serif;
        font-weight: 700;
        font-size: 16px;
        transition: opacity 0.2s;
      }
      .app-header nav a:hover {
        opacity: 0.8;
      }

      /* --- Notification Bell --- */
      .notification-bell {
        position: relative;
        font-size: 20px;
        cursor: pointer; /* FIX: Bell is clickable again */
      }
      .notification-count {
        position: absolute;
        top: -5px;
        right: -10px;
        background: #dbdae7;
        color: #e72e40;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        font-weight: bold;
        display: none;
        justify-content: center;
        align-items: center;
        font-family: Muller, sans-serif;
      }
      .notification-count.visible {
        display: flex;
      }

      /* --- Base Modal Styles --- */
      .modal-backdrop {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1999;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      .modal-backdrop.visible {
        display: block;
        opacity: 1;
      }
      .modal {
        display: none;
        position: fixed;
        background: white;
        border: 1px solid #e72e40;
        border-radius: 18px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        z-index: 2000;
        overflow: hidden;
        flex-direction: column;
        opacity: 0;
        transform: scale(0.95);
        transition: opacity 0.3s ease, transform 0.3s ease;
      }
      .modal.visible {
        display: flex;
        opacity: 1;
        transform: scale(1);
      }
      .modal-header {
        padding: 15px;
        background: #e72e40;
        color: white;
        font-family: "LEMON MILK", sans-serif;
        font-size: 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .modal-header .close-modal {
        font-size: 24px;
        cursor: pointer;
        font-weight: bold;
      }
      .modal-body {
        padding: 20px;
        overflow-y: auto;
        flex-grow: 1;
      }

      /* --- FIX: Notification Modal (Back from the dead) --- */
      .notification-modal {
        top: 70px; /* Position from top */
        right: 20px;
        width: 380px;
        max-height: 450px;
        transform: translateX(100%) scale(0.95);
      }
      .notification-modal.visible {
        transform: translateX(0) scale(1);
      }
      .notification-list {
        padding: 0; /* Remove padding from modal-body */
      }
      .notification-item {
        padding: 12px 20px;
        border-bottom: 1px solid #eee;
        font-size: 14px;
      }
      .notification-item:last-child {
        border-bottom: none;
      }
      .notification-item-text {
        margin-bottom: 10px;
        line-height: 1.4;
      }
      /* Style for read notifications */
      .notification-item.is-read .notification-item-text {
        color: #888;
      }
      .notification-actions {
        display: flex;
        gap: 10px;
      }
      .notification-actions button {
        font-family: "LEMON MILK", sans-serif;
        border: none;
        border-radius: 5px;
        padding: 5px 10px;
        cursor: pointer;
        font-size: 12px;
      }
      .notif-btn-approve {
        background: #28a745;
        color: white;
      }
      .notif-btn-deny {
        background: #dc3545;
        color: white;
      }

      /* --- Results Modal (Unchanged) --- */
      .results-modal {
        top: 50%;
        left: 50%;
        width: 500px;
        transform: translate(-50%, -50%) scale(0.95);
      }
      .results-modal.visible {
        transform: translate(-50%, -50%) scale(1);
      }
      .metric {
        font-size: 20px;
        margin: 15px 0;
        color: #e72e40;
        font-family: "LEMON MILK", sans-serif;
        font-weight: 700;
        text-align: center;
      }
      .metric span {
        font-weight: 700;
        color: #e72e40b0;
      }

      /* --- NEW: Toast Container --- */
      #toast-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .toast {
        width: 350px;
        background: #ffffff;
        border: 1px solid #e72e40;
        border-left: 5px solid #e72e40;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        padding: 16px;
        font-family: Muller, sans-serif;
        font-size: 15px;
        line-height: 1.4;
        color: #333;
        /* Animation */
        opacity: 0;
        transform: translateX(100%);
        animation: slideIn 0.5s forwards, fadeOut 0.5s 4.5s forwards;
      }
      @keyframes slideIn {
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      @keyframes fadeOut {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
          transform: translateX(100%);
        }
      }
      .toast.error {
        border-left-color: #dc3545;
      }
      .toast.error strong {
        color: #dc3545;
      }
      .toast.success {
        border-left-color: #28a745;
      }
      .toast.success strong {
        color: #28a745;
      }
      .toast strong {
        color: #e72e40;
      }

      /* --- Main Content Block --- */
      .content-wrapper {
        padding: 30px 40px;
      }
            .file-ext-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 40px;
        padding: 2px 10px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        background: #222;
        color: #fff;
        margin-right: 8px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      /* optional: slightly different colors per type */
      .file-ext-pdf {
        background: #b00020;
      }
      .file-ext-png,
      .file-ext-jpg,
      .file-ext-jpeg {
        background: #0066cc;
      }
      .file-ext-exe {
        background: #444;
      }

    </style>

    {% block head %}{% endblock %}
  </head>
  <body>
    <header class="app-header">
      <div class="logo">Golshi's Encryptor</div>
      <nav>
        <a href="{{ url_for('dashboard') }}">Dashboard</a>
        <a href="{{ url_for('find_users') }}">Find Users</a>
        <!-- FIX: Bell is clickable again -->
        <a href="#" class="notification-bell" id="notification-bell">
          <i class="fas fa-bell"></i>
          <span class="notification-count" id="notification-count">0</span>
        </a>
        <a href="{{ url_for('logout') }}">Logout</a>
      </nav>
    </header>

    <main class="content-wrapper">{% block content %}{% endblock %}</main>

    <div class="modal-backdrop" id="modal-backdrop"></div>

    <!-- FIX: Notification Modal is BACK -->
    <div class="modal notification-modal" id="notification-modal">
      <div class="modal-header">
        <span>Notifications</span>
        <span class="close-modal" data-modal="notification-modal">&times;</span>
      </div>
      <div class="notification-list modal-body" id="notification-list">
        <!-- JavaScript builds this -->
      </div>
    </div>

    <!-- Results Modal (Unchanged) -->
    <div class="modal results-modal" id="results-modal">
      <div class="modal-header">
        <span>Performance Results</span>
        <span class="close-modal" data-modal="results-modal">&times;</span>
      </div>
      <div class="modal-body">
        <div class="metric" id="res-operation">Operation: <span>...</span></div>
        <div class="metric" id="res-algorithm">Method: <span>...</span></div>
        <div class="metric" id="res-time">
          Time Executed: <span>...</span> s
        </div>
        <div class="metric" id="res-size">
          Output Size: <span>...</span> bytes
        </div>
      </div>
    </div>

    <div
      class="modal confirm-modal"
      id="confirm-modal"
      style="
        width: 450px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.95);
      "
    >
      <div class="modal-header">
        <span>Confirm Action</span>
        <span class="close-modal" data-modal="confirm-modal">&times;</span>
      </div>
      <div class="modal-body" style="text-align: center">
        <p
          id="confirm-modal-text"
          style="font-size: 1.1em; line-height: 1.5; margin-bottom: 25px"
        >
          Are you sure?
        </p>
        <div style="display: flex; gap: 10px; justify-content: center">
          <button
            class="animated-button"
            id="confirm-modal-cancel"
            style="
              background: #6c757d;
              box-shadow: 0 0 0 2px #6c757d;
              flex-basis: 150px;
            "
          >
            <span class="text" style="color: white">Cancel</span>
            <span class="circle" style="background: white"></span>
          </button>
          <button
            class="animated-button"
            id="confirm-modal-confirm"
            style="flex-basis: 150px"
          >
            <span class="text">Confirm</span>
            <span class="circle"></span>
          </button>
        </div>
      </div>
    </div>

    <!-- FILE PASSWORD / APPROVAL MODAL -->
    <div
      class="modal file-approval-modal"
      id="file-approval-modal"
      style="
        width: 450px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.95);
      "
    >
      <div class="modal-header">
        <span>Approve File Request</span>
        <span class="close-modal" data-modal="file-approval-modal">&times;</span>
      </div>
      <div class="modal-body" style="text-align: center">
        <p
          id="file-approval-text"
          style="font-size: 1.05em; line-height: 1.4; margin-bottom: 15px"
        >
          Enter the File Password to securely share it:
        </p>

        <input
          type="password"
          id="file-approval-password"
          placeholder="File password"
          style="
            width: 100%;
            max-width: 320px;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 14px;
            margin-bottom: 20px;
          "
        />

        <div style="display: flex; gap: 10px; justify-content: center">
          <button
            class="animated-button"
            id="file-approval-cancel"
            style="
              background: #6c757d;
              box-shadow: 0 0 0 2px #6c757d;
              flex-basis: 150px;
            "
          >
            <span class="text" style="color: white">Cancel</span>
            <span class="circle" style="background: white"></span>
          </button>
          <button
            class="animated-button"
            id="file-approval-confirm"
            style="flex-basis: 150px"
          >
            <span class="text">Approve</span>
            <span class="circle"></span>
          </button>
        </div>
      </div>
    </div>

        <!-- LOGIN PASSWORD / SIGNATURE MODAL -->
    <div
      class="modal login-password-modal"
      id="login-password-modal"
      style="
        width: 450px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.95);
      "
    >
      <div class="modal-header">
        <span>Verify Identity</span>
        <span class="close-modal" data-modal="login-password-modal">&times;</span>
      </div>
      <div class="modal-body" style="text-align: center">
        <p
          id="login-password-text"
          style="font-size: 1.05em; line-height: 1.4; margin-bottom: 15px"
        >
          Please enter your LOGIN password to verify your identity for the
          digital signature:
        </p>

        <input
          type="password"
          id="login-password-input"
          placeholder="Login password"
          style="
            width: 100%;
            max-width: 320px;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 14px;
            margin-bottom: 20px;
          "
        />

        <div style="display: flex; gap: 10px; justify-content: center">
          <button
            class="animated-button"
            id="login-password-cancel"
            style="
              background: #6c757d;
              box-shadow: 0 0 0 2px #6c757d;
              flex-basis: 150px;
            "
          >
            <span class="text" style="color: white">Cancel</span>
            <span class="circle" style="background: white"></span>
          </button>
          <button
            class="animated-button"
            id="login-password-confirm"
            style="flex-basis: 150px"
          >
            <span class="text">OK</span>
            <span class="circle"></span>
          </button>
        </div>
      </div>
    </div>


    <!-- NEW: Toast Container -->
    <div id="toast-container"></div>

    <!-- Centralized sound script (unchanged) -->
    <script>
      (function () {
        const soundList = [
          "{{ url_for('static', filename='sound1.mp3') }}",
          "{{ url_for('static', filename='sound2.mp3') }}",
        ];
        const minTime = 5000;
        const maxTime = 30000;

        function playRandomSound() {
          const randomIndex = Math.floor(Math.random() * soundList.length);
          const soundToPlay = soundList[randomIndex];
          const annoyingAudio = new Audio(soundToPlay);
          annoyingAudio.volume = 0.2;
          annoyingAudio.play().catch((e) => {});
          const randomTime = Math.random() * (maxTime - minTime) + minTime;
          setTimeout(playRandomSound, randomTime);
        }
        setTimeout(playRandomSound, 2000);
      })();
    </script>

    <!-- === REWRITTEN JAVASCRIPT FOR TOASTS & MODALS === -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // --- Modal Globals ---
        const backdrop = document.getElementById("modal-backdrop");
        const allModals = document.querySelectorAll(".modal");
        const allCloseBtns = document.querySelectorAll(".close-modal");
        let _modalCloseCallback = null;

        let _confirmCallback = null;
        const confirmModalCancel = document.getElementById(
          "confirm-modal-cancel"
        );
        const confirmModalConfirm = document.getElementById(
          "confirm-modal-confirm"
        );
        confirmModalCancel.addEventListener("click", hideModals);

        confirmModalConfirm.addEventListener("click", function () {
          if (typeof _confirmCallback === "function") {
            _confirmCallback();
          }
          hideModals();
          _confirmCallback = null;
        });

        // === Helper to build the little "PDF/PNG/..." badge ===
        function buildFileTypeBadgeFromText(plainText) {
          // try to match something like: "access to filename.ext"
          let filename = null;
          const mName = plainText.match(/access to\s+(.+?)(?:\.$|$)/i);
          if (mName) {
            filename = mName[1].trim();
          }
          if (!filename) return "";

          const mExt = filename.match(/\.([a-z0-9]{1,5})$/i);
          if (!mExt) return "";

          const ext = mExt[1].toLowerCase();
          const cls = "file-ext-badge file-ext-" + ext;
          return `<span class="${cls}">${ext.toUpperCase()}</span>`;
        }

                // --- FILE APPROVAL MODAL SETUP ---
        const fileApprovalModal = document.getElementById("file-approval-modal");
                const fileApprovalText = document.getElementById("file-approval-text");
        const fileApprovalPasswordInput = document.getElementById(
          "file-approval-password"
        );
        const fileApprovalCancelBtn = document.getElementById(
          "file-approval-cancel"
        );
        const fileApprovalConfirmBtn = document.getElementById(
          "file-approval-confirm"
        );
        let _pendingFileApproval = null; // { itemElement, requestId, type, action }

        function showFileApprovalModal(itemElement, requestId, type, action) {
          _pendingFileApproval = { itemElement, requestId, type, action };

          const notifTextEl = itemElement.querySelector(
            ".notification-item-text"
          );

          let plainText =
            notifTextEl?.textContent?.trim() ||
            "Enter the File Password to securely share it:";

          // ðŸ”¹ THIS is where the helper is actually used
          const badgeHtml = buildFileTypeBadgeFromText(plainText);

          fileApprovalText.innerHTML = `
            ${badgeHtml}${plainText}<br>
            <span style="font-size: 0.9em; opacity: 0.85;">
              Enter the File Password to securely share it:
            </span>
          `;

          fileApprovalPasswordInput.value = "";
          showModal("file-approval-modal");
          setTimeout(() => fileApprovalPasswordInput.focus(), 30);
        }

        // Cancel button
        fileApprovalCancelBtn.addEventListener("click", () => {
          _pendingFileApproval = null;
          hideModals();
        });

        // Approve button
        fileApprovalConfirmBtn.addEventListener("click", () => {
          if (!_pendingFileApproval) {
            hideModals();
            return;
          }
          const pw = fileApprovalPasswordInput.value.trim();
          if (!pw) {
            window.showToast("File password is required.", "error");
            return;
          }

          const { itemElement, requestId, type, action } = _pendingFileApproval;
          _pendingFileApproval = null;
          hideModals();
          respondToNotificationInternal(
            itemElement,
            requestId,
            type,
            action,
            pw
          );
        });

                // --- LOGIN PASSWORD / SIGNATURE MODAL SETUP ---
        const loginPasswordModal = document.getElementById(
          "login-password-modal"
        );
        const loginPasswordText = document.getElementById(
          "login-password-text"
        );
        const loginPasswordInput = document.getElementById(
          "login-password-input"
        );
        const loginPasswordCancelBtn = document.getElementById(
          "login-password-cancel"
        );
        const loginPasswordConfirmBtn = document.getElementById(
          "login-password-confirm"
        );

        let _loginPasswordCallback = null;

        // Global helper you can call from any page
        window.requestLoginPasswordForSignature = function (
          onPasswordEntered,
          customText
        ) {
          _loginPasswordCallback = onPasswordEntered || null;
          if (customText) {
            loginPasswordText.textContent = customText;
          } else {
            loginPasswordText.textContent =
              "Please enter your LOGIN password to verify your identity for the digital signature:";
          }
          loginPasswordInput.value = "";
          showModal("login-password-modal");
          setTimeout(() => loginPasswordInput.focus(), 30);
        };

        loginPasswordCancelBtn.addEventListener("click", () => {
          _loginPasswordCallback = null;
          hideModals();
        });

        loginPasswordConfirmBtn.addEventListener("click", () => {
          const pw = loginPasswordInput.value.trim();
          if (!pw) {
            window.showToast("Login password is required.", "error");
            return;
          }
          const cb = _loginPasswordCallback;
          _loginPasswordCallback = null;
          hideModals();
          if (typeof cb === "function") {
            cb(pw);
          }
        });




        function showModal(modalId) {
          const modal = document.getElementById(modalId);
          if (!modal) return;
          backdrop.classList.add("visible");
          modal.classList.add("visible");
        }

        function hideModals() {
          backdrop.classList.remove("visible");
          allModals.forEach((m) => m.classList.remove("visible"));
          if (typeof _modalCloseCallback === "function") {
            _modalCloseCallback();
            _modalCloseCallback = null;
          }
        }

        allCloseBtns.forEach((btn) =>
          btn.addEventListener("click", hideModals)
        );
        backdrop.addEventListener("click", hideModals);

        // --- Notification System ---
        const bell = document.getElementById("notification-bell");
        const notifModal = document.getElementById("notification-modal");
        const notifList = document.getElementById("notification-list");
        const notifCount = document.getElementById("notification-count");
        const toastContainer = document.getElementById("toast-container");
        let displayedToastIds = new Set();
        let hasFetchedOnce = false; // Flag to prevent initial toast storm

        // --- FIX: Bell is clickable again ---
        bell.addEventListener("click", (e) => {
          e.preventDefault();
          showModal("notification-modal");
          fetchAndRenderModalNotifications();
        });

        // --- 1. Fetches notifications for TOASTS ---
        function fetchNotificationsForToast() {
          fetch("{{ url_for('api_get_new_notifications') }}")
            .then((res) => res.json())
            .then((data) => {
              updateBellCount(data.new_notification_count);

              if (!hasFetchedOnce) {
                hasFetchedOnce = true;
                data.notifications.forEach((notif) =>
                  displayedToastIds.add(notif.id)
                );
                return;
              }

              data.notifications.forEach((notif) => {
                if (!displayedToastIds.has(notif.id)) {
                  createToast(notif);
                  displayedToastIds.add(notif.id);
                }
              });
            })
            .catch((err) =>
              console.error("Error fetching notifications:", err)
            );
        }

        // --- 2. Fetches notifications for the MODAL ---
        function fetchAndRenderModalNotifications() {
          notifList.innerHTML = `<div style="text-align: center; padding: 20px;">Loading...</div>`;
          // FIX: Call the new history route
          fetch("{{ url_for('api_get_notification_history') }}")
            .then((res) => res.json())
            .then((data) => {
              notifList.innerHTML = "";
              if (data.notifications.length === 0) {
                notifList.innerHTML = `<div style="text-align: center; padding: 20px; color: #666;">No notifications.</div>`;
                return;
              }
              data.notifications.forEach((notif) => {
                const item = document.createElement("div");
                item.className = "notification-item";
                if (notif.is_read) {
                  item.classList.add("is-read");
                }
                item.dataset.id = notif.id;
                item.dataset.type = notif.type;
                item.dataset.requestId = notif.request_id; // Store the *actual* request ID

                let actions = "";
                if (
                  notif.type === "friend_request" ||
                  notif.type === "file_request"
                ) {
                  actions = `
                                    <div class="notification-actions">
                                        <button class="notif-btn-approve" data-action="approve">Approve</button>
                                        <button class="notif-btn-deny" data-action="deny">Deny</button>
                                    </div>`;
                }

                const badgeHtml = buildFileTypeBadgeFromText(notif.text);
                item.innerHTML = `<div class="notification-item-text">${badgeHtml}${notif.text}</div>${actions}`;
                notifList.appendChild(item);
              });

              // After opening, the bell count should be 0
              updateBellCount(0);
            })
            .catch((err) => {
              notifList.innerHTML = `<div style="text-align: center; padding: 20px; color: red;">Error loading notifications.</div>`;
            });
        }

        // --- 3. Creates the visual toast ---
        function createToast(notification) {
          displayedToastIds.add(notification.id);
          markNotificationAsRead(notification.id);
          window.showToast(notification.text);
        }

        window.showToast = (message, type = "info") => {
          const toast = document.createElement("div");
          toast.className = "toast";
          if (type === "error") {
            toast.classList.add("error");
          } else if (type === "success") {
            toast.classList.add("success");
          }
          toast.innerHTML = message;
          toastContainer.appendChild(toast);
          const toastId = message.id ? message.id : null;

          setTimeout(() => {
            toast.remove();
            if (toastId) {
              displayedToastIds.delete(toastId);
            }
          }, 5000);
        };

        // --- 4. Marks a single notification as read ---
        function markNotificationAsRead(notifId) {
          fetch("{{ url_for('mark_read') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: notifId }),
          }).then(() => fetchNotificationSummary()); // Update bell count
        }

        // --- 5. Updates just the bell count (no toasts) ---
        function fetchNotificationSummary() {
          fetch("{{ url_for('api_get_new_notifications') }}")
            .then((res) => res.json())
            .then((data) => updateBellCount(data.new_notification_count));
        }

        function updateBellCount(count) {
          if (count > 0) {
            notifCount.textContent = count;
            notifCount.classList.add("visible");
          } else {
            notifCount.classList.remove("visible");
            notifCount.textContent = "0";
          }
        }

        // --- 6. Handle clicks *inside* the modal ---
        notifList.addEventListener("click", function (e) {
          const button = e.target.closest(
            ".notif-btn-approve, .notif-btn-deny"
          );
          if (!button) return;

          const item = button.closest(".notification-item");
          const requestId = item.dataset.requestId; // Use the *real* request ID
          const type = item.dataset.type;
          const action = button.dataset.action;

          respondToNotification(item, requestId, type, action);
        });

                function respondToNotification(itemElement, requestId, type, action) {
          // For file request APPROVE, open our custom UI window
          if (type === "file_request" && action === "approve") {
            showFileApprovalModal(itemElement, requestId, type, action);
          } else {
            // Friend requests and deny actions go straight through
            respondToNotificationInternal(
              itemElement,
              requestId,
              type,
              action,
              null
            );
          }
        }

        function respondToNotificationInternal(
          itemElement,
          requestId,
          type,
          action,
          filePassword
        ) {
          let url =
            type === "friend_request"
              ? `{{ url_for('api_respond_friend', request_id=0) }}`.replace(
                  "0",
                  requestId
                )
              : `{{ url_for('api_respond_file', request_id=0) }}`.replace(
                  "0",
                  requestId
                );

          // Disable buttons while processing
          itemElement
            .querySelectorAll("button")
            .forEach((b) => (b.disabled = true));

          fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              action: action,
              file_password: filePassword, // may be null
            }),
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                itemElement.style.opacity = "0.5";
                itemElement.innerHTML = `<div class="notification-item-text" style="color: #666;">Handled.</div>`;
                fetchNotificationSummary();
                if (action === "approve" && type === "file_request") {
                  window.showToast(
                    "<strong>Success:</strong> File request approved.",
                    "success"
                  );
                }
              } else {
                itemElement
                  .querySelectorAll("button")
                  .forEach((b) => (b.disabled = false));
                window.showToast(
                  "An error occurred: " + (data.error || "Unknown error"),
                  "error"
                );
              }
            })
            .catch((err) => {
              console.error("Error responding to notification:", err);
              itemElement
                .querySelectorAll("button")
                .forEach((b) => (b.disabled = false));
              window.showToast(
                "An error occurred while contacting the server.",
                "error"
              );
            });
        }

        window.showConfirmModal = (text, confirmCallback) => {
          document.getElementById("confirm-modal-text").textContent = text;
          _confirmCallback = confirmCallback;
          showModal("confirm-modal");
        };
        // --- Results Modal Function (Unchanged) ---
        window.showResultsModal = (metrics, onModalCloseCallback = null) => {
          _modalCloseCallback = onModalCloseCallback;
          document.getElementById(
            "res-operation"
          ).innerHTML = `Operation: <span>${metrics.operation}</span>`;
          document.getElementById(
            "res-algorithm"
          ).innerHTML = `Method: <span>${metrics.algorithm}</span>`;
          document.getElementById(
            "res-time"
          ).innerHTML = `Time Executed: <span>${metrics.time.toFixed(
            6
          )} s</span>`;
          document.getElementById(
            "res-size"
          ).innerHTML = `Output Size: <span>${metrics.size} bytes</span>`;
          showModal("results-modal");
        };

        // --- Initial Load & Polling ---
        fetchNotificationsForToast(); // This will show toasts for new notifs
        setInterval(fetchNotificationsForToast, 5000); // Poll every 5 seconds
      });
    </script>

    {% block scripts %}{% endblock %}
  </body>
</html>
